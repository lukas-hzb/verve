{% extends "base.html" %}

{% block content %}
<div
    style="padding: 15px var(--space-6) var(--space-6) var(--space-6); max-width: 1400px; width: 100%; margin: 0 auto;">

    <!-- Secondary Header -->
    <div style="margin-bottom: var(--space-6);">
        <div class="card-header-secondary">
            <h1 class="card-header-secondary-title">{{ set_name.replace('_', ' ') | title }} Overview</h1>
            <div class="button-group">
                <button class="btn-secondary" onclick="openRenameModal()" style="white-space: nowrap;">
                    <span class="material-symbols-outlined">edit</span> Rename
                </button>
                <button class="btn-secondary" onclick="openAddCardModal()" style="white-space: nowrap;">
                    <span class="material-symbols-outlined">add</span> Add Card
                </button>
                <button class="btn-secondary" onclick="openImportModal()" style="white-space: nowrap;">
                    <span class="material-symbols-outlined">upload_file</span> Import
                </button>
            </div>
        </div>
    </div>

    <!-- Quick Actions Cards -->
    <div style="margin-bottom: var(--space-8);">
        <div class="card-grid-2">
            <a href="{{ url_for('main.learn_set', set_id=set_id) }}" class="card-clickable">
                <div class="card-clickable-title">
                    <span class="material-symbols-outlined card-clickable-icon">menu_book</span>
                    Learn
                </div>
                <p class="card-clickable-text">Start learning session</p>
                <span class="material-symbols-outlined card-clickable-arrow">arrow_forward</span>
            </a>

            <a href="{{ url_for('main.stats', set_id=set_id) }}" class="card-clickable">
                <div class="card-clickable-title">
                    <span class="material-symbols-outlined card-clickable-icon">bar_chart</span>
                    Statistics
                </div>
                <p class="card-clickable-text">View progress and stats</p>
                <span class="material-symbols-outlined card-clickable-arrow">arrow_forward</span>
            </a>
        </div>
    </div>

    <!-- Cards List -->
    <div style="margin-bottom: var(--space-8);">
        <h2 style="margin-bottom: var(--space-4);">Cards</h2>

        <!-- Search Bar -->
        <div class="card-normal" style="margin-bottom: var(--space-6);">
            <div class="card-input-group">
                <span class="material-symbols-outlined card-input-icon">search</span>
                <input type="text" id="cardSearchInput" class="card-input card-input-with-icon"
                    placeholder="Search cards..." autocomplete="off" onkeyup="filterCards()">
            </div>
        </div>

        <div id="cards-list" class="card-list" style="padding: 0;">
            <!-- Cards will be loaded via JS and appended as card-list-item -->
            <div style="text-align: center; padding: var(--space-6); color: var(--color-text-muted);"
                id="loading-indicator">Loading...</div>
        </div>
    </div>

    <!-- Danger Zone -->
    <div class="card-attention">
        <div class="card-attention-header">
            <span class="material-symbols-outlined card-attention-icon">warning</span>
            <h3 class="card-attention-title">Danger Zone</h3>
        </div>
        <p class="card-attention-text" style="margin-bottom: var(--space-4);">Deleting a set is permanent and cannot be
            undone.</p>
        <button class="btn-danger" onclick="confirmDeleteSet()">
            <span class="material-symbols-outlined">delete_forever</span>
            Delete Set
        </button>
        <form id="deleteSetForm" action="/set/{{ set_id }}/delete" method="POST" style="display: none;"></form>
    </div>
</div>

<!-- Rename Set Modal -->
<div id="renameModal" class="popup-overlay">
    <div class="popup-content">
        <div class="popup-header">
            <h3 class="popup-title">Rename Set</h3>
            <button class="popup-close-btn" onclick="closeRenameModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="popup-body">
            <form action="/set/{{ set_id }}/rename" method="POST">
                <div class="card-input-group">
                    <label for="new_name" class="card-input-label">New Name</label>
                    <input type="text" id="new_name" name="new_name" value="{{ set_name }}" required
                        pattern="[a-zA-Z0-9_\-äöüÄÖÜß]+" title="Allowed characters: Letters, numbers, -, _ and umlauts"
                        class="card-input">
                    <div class="card-input-description">Allowed characters: Letters, numbers, -, _ and umlauts</div>
                </div>
                <div class="popup-footer">
                    <button type="button" class="btn-secondary" onclick="closeRenameModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Card Modal -->
<div id="addCardModal" class="popup-overlay">
    <div class="popup-content">
        <div class="popup-header">
            <h3 class="popup-title">Add New Card</h3>
            <button class="popup-close-btn" onclick="closeAddCardModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="popup-body">
            <form id="addCardForm" onsubmit="handleAddCard(event)">
                <div class="card-input-group">
                    <label for="front" class="card-input-label">Front</label>
                    <input type="text" id="front" name="front" required class="card-input" placeholder="rogare" />
                    <div class="card-input-description">Shown first</div>
                </div>
                <div class="card-input-group">
                    <label for="back" class="card-input-label">Back</label>
                    <input type="text" id="back" name="back" required class="card-input" placeholder="to ask" />
                    <div class="card-input-description">The answer you want to learn</div>
                </div>
                <div class="popup-footer">
                    <button type="button" class="btn-secondary" onclick="closeAddCardModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="importModal" class="popup-overlay">
    <div class="popup-content" style="max-width: 600px;">
        <div class="popup-header">
            <h3 class="popup-title">Import Cards</h3>
            <button class="popup-close-btn" onclick="closeImportModal()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>
        <div class="popup-body">
            <form action="{{ url_for('main.import_into_set', set_id=set_id) }}" method="POST"
                enctype="multipart/form-data" id="importForm">

                <div class="import-tabs">
                    <div class="import-tab active" id="tab-file" onclick="switchTab('file')">File Upload</div>
                    <div class="import-tab" id="tab-text" onclick="switchTab('text')">Text Input</div>
                </div>

                <input type="hidden" name="import_type" id="import_type" value="file">

                <div id="file-section" class="import-section">
                    <div class="card-input-group">
                        <label class="card-input-label">Select File (CSV, TSV, TXT)</label>
                        <div class="import-file-area" onclick="document.getElementById('import-file').click()">
                            <span class="material-symbols-outlined import-file-icon">upload_file</span>
                            <span class="import-file-text">Click to
                                upload file</span>
                            <input type="file" id="import-file" name="file" accept=".csv,.tsv,.txt"
                                style="display: none;" onchange="updateFileName(this)">
                            <span id="file-name" class="import-file-name"></span>
                        </div>
                    </div>
                </div>

                <div id="text-section" class="import-section" style="display: none;">
                    <div class="card-input-group">
                        <label for="text_content" class="card-input-label">Enter Vocabulary</label>
                        <textarea id="text_content" name="text_content" class="card-input import-textarea" rows="3"
                            placeholder="Dog, Hund&#10;Cat, Katze"></textarea>
                    </div>
                </div>

                <div class="import-box">
                    <div class="card-input-label" style="margin-bottom: var(--space-3);">Settings
                    </div>
                    <div style="display: flex; gap: var(--space-4);">
                        <div style="flex: 1;">
                            <select id="field_separator" name="field_separator" class="card-input"
                                onchange="toggleCustom('field'); updatePreview()">
                                <option value="\t">Tab (\t)</option>
                                <option value="," selected>Comma (,)</option>
                                <option value=";">Semicolon (;)</option>
                                <option value="|">Pipe (|)</option>
                                <option value="custom">Custom</option>
                            </select>
                            <input type="text" id="custom_field_separator" name="custom_field_separator"
                                class="card-input mt-2" style="display: none; margin-top: var(--space-2);"
                                placeholder="e.g. - or \t" oninput="updatePreview()">
                            <div class="card-input-description">Field Separator</div>
                        </div>
                        <div style="flex: 1;">
                            <select id="card_separator" name="card_separator" class="card-input"
                                onchange="toggleCustom('card'); updatePreview()">
                                <option value="\n">Newline (\n)</option>
                                <option value=";">Semicolon (;)</option>
                                <option value="|">Pipe (|)</option>
                                <option value="custom">Custom</option>
                            </select>
                            <input type="text" id="custom_card_separator" name="custom_card_separator"
                                class="card-input mt-2" style="display: none; margin-top: var(--space-2);"
                                placeholder="e.g. \n\n or ;" oninput="updatePreview()">
                            <div class="card-input-description">Card Separator</div>
                        </div>
                    </div>
                </div>

                <div id="preview-section" class="preview-section import-preview-box" style="display: none;">
                    <div class="preview-header-container">
                        <div class="card-input-label" style="margin-bottom: 0;">Preview (First Card)</div>
                        <span id="preview-note" class="preview-note"></span>
                    </div>
                    <div class="preview-grid">
                        <div class="preview-column">
                            <strong class="preview-label-compact">FRONT</strong>
                            <div id="preview-front" class="preview-content"></div>
                        </div>
                        <div class="preview-separator"></div>
                        <div class="preview-column">
                            <strong class="preview-label-compact">BACK</strong>
                            <div id="preview-back" class="preview-content"></div>
                        </div>
                    </div>
                </div>

                <div class="popup-footer">
                    <button type="button" class="btn-secondary" onclick="closeImportModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Import</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    async function fetchCards() {
        const response = await fetch(`/api/set/${window.setId}/cards`);
        const data = await response.json();
        const container = document.getElementById('cards-list');
        const loading = document.getElementById('loading-indicator');
        if (loading) loading.style.display = 'none';

        // Clear except if there are existing items we want to keep? No, clear all to reload.
        // But need to be careful if we want to keep headers. The container IS the list.
        container.innerHTML = '';
        
        // Add style for wrong items dynamically
        if (!document.getElementById('wrong-card-style')) {
             const style = document.createElement('style');
             style.id = 'wrong-card-style';
             style.textContent = `
                .card-list-item-wrong {
                    border: 1px solid var(--color-accent-1) !important;
                    z-index: 1;
                    position: relative; /* Needed for z-index */
                }
                /* Prevent double borders */
                .card-list-item-wrong + .card-list-item-wrong {
                    border-top: none !important;
                }
                
                /* Ensure radius on first/last items */
                .card-list-item:first-child.card-list-item-wrong {
                    border-top-left-radius: var(--radius-xl) !important;
                    border-top-right-radius: var(--radius-xl) !important;
                }
                .card-list-item:last-child.card-list-item-wrong {
                    border-bottom-left-radius: var(--radius-xl) !important;
                    border-bottom-right-radius: var(--radius-xl) !important;
                    border-bottom: 1px solid var(--color-accent-1) !important;
                }
             `;
             document.head.appendChild(style);
        }

        if (data.cards.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: var(--color-text-muted); padding: var(--space-4);">No cards in this set yet.</p>';
            return;
        }

        data.cards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'card-list-item';
            
            if (card.last_practice_wrong) {
                div.style.border = '1px solid var(--color-accent-1)';
                // Ensure border radius is respected if it's the first or last item
                // The CSS controls border-radius on first/last-child, but our inline style overrides the border property.
                // We should add a class instead or handle it carefully.
                // Since inline border overrides CSS border, we need to ensure we don't break the rounded corners
                // of the container by making square corners on the item.
                // But card-list-item usually has square corners except first/last.
                // Best approach: Use a specific class 'card-list-item-wrong' and handle it in CSS?
                // Or just set border-radius in JS if needed?
                // Actually, card-list-item logic in CSS might be:
                // .card-list-item:first-child { border-top-left-radius: ... }
                // So adding a border shouldn't change the radius unless we change 'overflow'.
                // If the issue is that the border *looks* weird because it's square on a rounded container:
                // Let's try adding a class and rely on CSS, but since I can't edit CSS easily without seeing it...
                // Let's assume the user means it looks bad because it doesn't follow the container's rounding.
                // I will add a class and style it inline with specific attention to potential first/last child issues.
                
                // Let's try this:
                // Check if it is first or last child? No, we are building the list.
                // Simple fix: rely on CSS class.
            }
            // Actually, let's use a class to be cleaner and handle :first-child/:last-child in CSS if possible.
            // But I cannot edit the main CSS file easily? Wait, I can edit <style> in base or here.
            // But this is set_overview.html. 
            // Let's stick to inline style but be smarter.
            // If I just add 'border-color: red', it might fallback to default border width/style.
            // card-list-item usually has border-bottom.
            // If I set 'border', it sets all 4 sides. 
            // The user said "because the top and bottom element of this list are not rectangles".
            // This implies the list container has rounded corners, and the items need to match.
            // The user said "because the top and bottom element of this list are not rectangles".
            // This implies the list container has rounded corners, and the items need to match.
            // We can just add 'overflow: hidden' to the container? Or ensure items have radius.
            
            if (card.last_practice_wrong || card.level === 1) {
                 div.classList.add('card-list-item-wrong');
            }
            
            div.innerHTML = `
                <div class="card-list-item-info">
                    <span class="card-list-item-title">${card.front}</span>
                    <span class="card-list-item-subtitle">${card.back}</span>
                </div>
                <button class="card-list-delete-btn" onclick="deleteCard('${card.id}')" title="Delete Card">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            `;
            container.appendChild(div);
        });
    }

    // ... (Remainder of functions: openAddCardModal, closeAddCardModal, openImportModal, etc.)
    // Keeping logic consistent with previous version but ensuring new HTML elements are targeted correctly.

    function openAddCardModal() { document.getElementById('addCardModal').classList.add('active'); }
    function closeAddCardModal() { document.getElementById('addCardModal').classList.remove('active'); }

    function openImportModal() { document.getElementById('importModal').classList.add('active'); }
    function closeImportModal() { document.getElementById('importModal').classList.remove('active'); }

    function updateFileName(input) {
        const fileNameDisplay = document.getElementById('file-name');
        if (input.files && input.files[0]) {
            fileNameDisplay.textContent = input.files[0].name;
            // No need to set color here as it is handled by CSS class .import-file-name
        } else {
            fileNameDisplay.textContent = '';
        }
    }

    async function handleAddCard(event) {
        event.preventDefault();
        const front = document.getElementById('front').value;
        const back = document.getElementById('back').value;
        const response = await fetch(`/set/${window.setId}/add_card`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ front, back })
        });
        if (response.ok) {
            closeAddCardModal();
            document.getElementById('front').value = '';
            document.getElementById('back').value = '';
            fetchCards();
        } else {
            const data = await response.json();
            alert('Failed to add card: ' + (data.error || 'Unknown error'));
        }
    }

    window.deleteCard = function (cardId) {
        window.showConfirmationModal({
            title: "Delete Card",
            message: "Are you sure you want to delete this card?",
            confirmText: "Delete",
            confirmClass: "btn-danger",
            onConfirm: async () => {
                const response = await fetch(`/api/set/${window.setId}/card/${cardId}`, {
                    method: 'DELETE'
                });
                if (response.ok) {
                    fetchCards();
                } else {
                    const data = await response.json();
                    alert('Failed to delete card: ' + (data.error || 'Unknown error'));
                }
            }
        });
    }

    function confirmDeleteSet() {
        window.showConfirmationModal({
            title: "Delete Set",
            message: "Are you sure you want to delete this set? This cannot be undone.",
            confirmText: "Delete Set",
            confirmClass: "btn-danger",
            onConfirm: () => {
                document.getElementById('deleteSetForm').submit();
            }
        });
    }

    window.setId = "{{ set_id }}";
    fetchCards();

    function openRenameModal() { document.getElementById('renameModal').classList.add('active'); }
    function closeRenameModal() { document.getElementById('renameModal').classList.remove('active'); }

    window.onclick = function (event) {
        if (event.target.classList.contains('popup-overlay')) {
            event.target.classList.remove('active');
        }
    }

    function switchTab(type) {
        const tabFile = document.getElementById('tab-file');
        const tabText = document.getElementById('tab-text');

        // Reset both
        tabFile.classList.remove('active');
        tabText.classList.remove('active');

        // Activate selected
        if (type === 'file') {
            tabFile.classList.add('active');
        } else {
            tabText.classList.add('active');
        }

        document.getElementById('import_type').value = type;

        if (type === 'file') {
            document.getElementById('file-section').style.display = 'block';
            document.getElementById('text-section').style.display = 'none';
            document.getElementById('text_content').required = false;
            document.getElementById('text_content').value = '';
            updatePreview();
        } else {
            document.getElementById('file-section').style.display = 'none';
            document.getElementById('text-section').style.display = 'block';
            document.getElementById('import-file').required = false;
            document.getElementById('text_content').required = true;
            const fileInput = document.getElementById('import-file');
            fileInput.value = '';
            const fileNameDisplay = document.getElementById('file-name');
            if (fileNameDisplay) {
                fileNameDisplay.textContent = '';
            }
            updatePreview();
        }
    }

    // Default tab
    // No need to call it here if we want to default to file, the HTML already has file active.
    // Calling it ensures state is consistent.
    switchTab('file');

    function toggleCustom(type) {
        const select = document.getElementById(type + '_separator');
        const customInput = document.getElementById('custom_' + type + '_separator');
        if (select.value === 'custom') {
            customInput.style.display = 'block';
            customInput.required = true;
        } else {
            customInput.style.display = 'none';
            customInput.required = false;
        }
    }

    function filterCards() {
        const input = document.getElementById('cardSearchInput');
        const filter = input.value.toLowerCase();
        const container = document.getElementById('cards-list');
        const cards = container.getElementsByClassName('card-list-item');
        let visibleCards = [];

        for (let i = 0; i < cards.length; i++) {
            const frontElement = cards[i].querySelector('.card-list-item-title');
            const backElement = cards[i].querySelector('.card-list-item-subtitle');

            let match = false;

            if (frontElement) {
                const frontValue = frontElement.textContent || frontElement.innerText;
                if (frontValue.toLowerCase().indexOf(filter) > -1) {
                    match = true;
                }
            }

            if (!match && backElement) {
                const backValue = backElement.textContent || backElement.innerText;
                if (backValue.toLowerCase().indexOf(filter) > -1) {
                    match = true;
                }
            }

            // Reset styles
            cards[i].style.borderBottom = "";

            if (match) {
                cards[i].style.display = ""; // Restore default display
                visibleCards.push(cards[i]);
            } else {
                cards[i].style.display = "none";
            }
        }

        // Remove border from the last visible card
        if (visibleCards.length > 0) {
            visibleCards[visibleCards.length - 1].style.borderBottom = "none";
        }
    }

    function updatePreview() {

        const importType = document.getElementById('import_type').value;
        let content = '';
        if (importType === 'text') {
            content = document.getElementById('text_content').value;
        } else {
            document.getElementById('preview-section').style.display = 'none';
            return;
        }
        if (!content.trim()) {
            document.getElementById('preview-section').style.display = 'none';
            return;
        }
        let cardSep = document.getElementById('card_separator').value;
        let fieldSep = document.getElementById('field_separator').value;
        if (cardSep === 'custom') {
            cardSep = document.getElementById('custom_card_separator').value || '\n';
        }
        if (fieldSep === 'custom') {
            fieldSep = document.getElementById('custom_field_separator').value || '\t';
        }
        cardSep = cardSep.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\r/g, '\r');
        fieldSep = fieldSep.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\r/g, '\r');
        let cards;
        if (cardSep === '\n') {
            cards = content.split(/\r?\n/);
        } else {
            cards = content.split(cardSep);
        }
        let firstCard = null;
        for (let card of cards) {
            card = card.trim();
            if (card) {
                firstCard = card;
                break;
            }
        }
        if (!firstCard) {
            document.getElementById('preview-section').style.display = 'none';
            return;
        }
        const parts = firstCard.split(fieldSep);
        const front = parts[0] ? parts[0].trim() : '';
        const back = parts[1] ? parts[1].trim() : '';
        document.getElementById('preview-front').textContent = front || '(empty)';
        document.getElementById('preview-back').textContent = back || '(empty)';
        const totalCards = cards.filter(c => c.trim()).length;
        document.getElementById('preview-note').textContent = `Total ${totalCards} card(s) recognized`;
        document.getElementById('preview-section').style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const textArea = document.getElementById('text_content');
        if (textArea) {
            textArea.addEventListener('input', updatePreview);
        }
    });
</script>
{% endblock %}