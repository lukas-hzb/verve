{% extends "base.html" %}

{% block content %}
<div style="padding: 7px var(--space-6) var(--space-6) var(--space-6); max-width: 800px; width: 100%; margin: 0 auto;">

    <div class="card-normal">
        <div style="margin-bottom: var(--space-6);">
            <h1 style="margin-bottom: var(--space-2);">Import Vocabulary</h1>
            <p style="color: var(--color-text-muted);">Create a new study set from a file or by text input.</p>
        </div>

        <form method="POST" enctype="multipart/form-data" class="import-form" id="importForm">
            <div class="card-input-group">
                <label for="set_name" class="card-input-label">Set Name</label>
                <input type="text" id="set_name" name="set_name" class="card-input" required
                    placeholder="e.g. Spanish Chapter 1">
            </div>

            <div class="button-group" style="margin-bottom: var(--space-4);">
                <div class="btn-secondary active" id="tab-file" onclick="switchTab('file')"
                    style="cursor: pointer; text-align: center; flex: 1;">Upload File</div>
                <div class="btn-secondary" id="tab-text" onclick="switchTab('text')"
                    style="cursor: pointer; text-align: center; flex: 1;">Enter Text</div>
            </div>

            <input type="hidden" name="import_type" id="import_type" value="file">

            <div id="file-section" class="import-section">
                <div class="card-input-group">
                    <label for="file" class="card-input-label">Select File (CSV, TSV, TXT)</label>
                    <div style="height: 100px; border: 2px dashed var(--color-border); border-radius: var(--radius-md); display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer;"
                        onclick="document.getElementById('file').click()">
                        <span class="material-symbols-outlined"
                            style="font-size: 32px; color: var(--color-text-muted);">upload_file</span>
                        <span style="color: var(--color-text-muted); margin-top: var(--space-2);">Click to upload
                            file</span>
                        <input type="file" id="file" name="file" accept=".csv,.tsv,.txt" style="display: none;"
                            onchange="updateFileName(this)">
                        <span id="file-name" style="margin-top: var(--space-2); font-weight: 500;"></span>
                    </div>
                </div>
            </div>

            <div id="text-section" class="import-section" style="display: none;">
                <div class="card-input-group">
                    <label for="text_content" class="card-input-label">Enter Vocabulary</label>
                    <textarea id="text_content" name="text_content" class="card-input" rows="5"
                        placeholder="Dog, Hund&#10;Cat, Katze"></textarea>
                </div>
            </div>

            <div
                style="background-color: var(--color-bg-surface-hover); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-6);">
                <h3 class="card-normal-title" style="margin-bottom: var(--space-3); font-size: var(--font-size-lg);">
                    Settings</h3>
                <div style="display: flex; gap: var(--space-4);">
                    <div style="flex: 1;">
                        <label for="field_separator" class="card-input-label">Separator (Front/Back)</label>
                        <select id="field_separator" name="field_separator" class="card-input"
                            onchange="toggleCustom('field'); updatePreview()">
                            <option value="\t">Tab (\t)</option>
                            <option value=",">Comma (,)</option>
                            <option value=";">Semicolon (;)</option>
                            <option value="|">Pipe (|)</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="text" id="custom_field_separator" name="custom_field_separator"
                            class="card-input mt-2" style="display: none; margin-top: var(--space-2);"
                            placeholder="e.g. - or \t" oninput="updatePreview()">
                    </div>
                    <div style="flex: 1;">
                        <label for="card_separator" class="card-input-label">Separator (Cards)</label>
                        <select id="card_separator" name="card_separator" class="card-input"
                            onchange="toggleCustom('card'); updatePreview()">
                            <option value="\n">New Line (\n)</option>
                            <option value=";">Semicolon (;)</option>
                            <option value="|">Pipe (|)</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="text" id="custom_card_separator" name="custom_card_separator"
                            class="card-input mt-2" style="display: none; margin-top: var(--space-2);"
                            placeholder="e.g. \n\n or ;" oninput="updatePreview()">
                    </div>
                </div>
            </div>

            <div id="preview-section" class="preview-section"
                style="display: none; background-color: var(--color-bg-body); padding: var(--space-4); border-radius: var(--radius-md); border: 1px solid var(--color-border); margin-bottom: var(--space-6);">
                <h4 style="margin-bottom: var(--space-2);">Preview (First Card)</h4>
                <div style="display: flex; gap: var(--space-4); align-items: center;">
                    <div style="flex: 1;">
                        <strong
                            style="display: block; font-size: var(--font-size-xs); color: var(--color-text-muted); text-transform: uppercase;">Front</strong>
                        <div id="preview-front"
                            style="font-family: monospace; background: var(--color-bg-surface); padding: var(--space-2); border-radius: var(--radius-sm);">
                        </div>
                    </div>
                    <div style="width: 1px; height: 40px; background-color: var(--color-border);"></div>
                    <div style="flex: 1;">
                        <strong
                            style="display: block; font-size: var(--font-size-xs); color: var(--color-text-muted); text-transform: uppercase;">Back</strong>
                        <div id="preview-back"
                            style="font-family: monospace; background: var(--color-bg-surface); padding: var(--space-2); border-radius: var(--radius-sm);">
                        </div>
                    </div>
                </div>
                <p id="preview-note"
                    style="margin-top: var(--space-2); font-style: italic; font-size: var(--font-size-sm); color: var(--color-text-muted);">
                </p>
            </div>

            <div style="display: flex; gap: var(--space-4);">
                <button type="submit" class="btn-primary">
                    <span class="material-symbols-outlined">upload</span> Import
                </button>
                <a href="{{ url_for('main.index') }}" class="btn-secondary">Cancel</a>
            </div>
        </form>

        <div
            style="margin-top: var(--space-8); padding-top: var(--space-6); border-top: 1px solid var(--color-border);">
            <h3 class="card-normal-title" style="margin-bottom: var(--space-2);">Format Instructions</h3>
            <p style="color: var(--color-text-muted); margin-bottom: var(--space-4);">By default, Front and Back are
                expected to be separated by a <strong>Tab</strong> and each card on a <strong>new line</strong>.</p>
            <div
                style="background-color: var(--color-bg-surface-hover); padding: var(--space-4); border-radius: var(--radius-md); font-family: monospace;">
                <p style="margin-bottom: var(--space-2); color: var(--color-text-muted);">Example (Comma as separator):
                </p>
                Hund, Dog<br>
                Katze, Cat<br>
                Haus, House
            </div>
        </div>
    </div>
</div>

<script>
    function updateFileName(input) {
        const fileNameDisplay = document.getElementById('file-name');
        if (input.files && input.files[0]) {
            fileNameDisplay.textContent = input.files[0].name;
            fileNameDisplay.style.color = "var(--color-primary)";
        } else {
            fileNameDisplay.textContent = '';
        }
    }

    function switchTab(type) {
        // Active/Inactive state logic
        if (type === 'file') {
            document.getElementById('tab-file').style.backgroundColor = 'var(--color-primary-muted)';
            document.getElementById('tab-file').style.color = 'white';
            document.getElementById('tab-text').style.backgroundColor = '';
            document.getElementById('tab-text').style.color = '';
        } else {
            document.getElementById('tab-text').style.backgroundColor = 'var(--color-primary-muted)';
            document.getElementById('tab-text').style.color = 'white';
            document.getElementById('tab-file').style.backgroundColor = '';
            document.getElementById('tab-file').style.color = '';
        }

        document.getElementById('import_type').value = type;

        if (type === 'file') {
            document.getElementById('file-section').style.display = 'block';
            document.getElementById('text-section').style.display = 'none';
            document.getElementById('file').required = true;
            document.getElementById('text_content').required = false;
            document.getElementById('text_content').value = '';
            updatePreview();
        } else {
            document.getElementById('file-section').style.display = 'none';
            document.getElementById('text-section').style.display = 'block';
            document.getElementById('file').required = false;
            document.getElementById('text_content').required = true;
            const fileInput = document.getElementById('file');
            fileInput.value = '';
            document.getElementById('file-name').textContent = '';
            updatePreview();
        }
    }

    // Init Visual State
    switchTab('file');

    function toggleCustom(type) {
        const select = document.getElementById(type + '_separator');
        const customInput = document.getElementById('custom_' + type + '_separator');

        if (select.value === 'custom') {
            customInput.style.display = 'block';
            customInput.required = true;
        } else {
            customInput.style.display = 'none';
            customInput.required = false;
        }
    }

    function updatePreview() {
        // Logic same as original
        const importType = document.getElementById('import_type').value;
        let content = '';

        if (importType === 'text') {
            content = document.getElementById('text_content').value;
        } else {
            document.getElementById('preview-section').style.display = 'none';
            return;
        }

        if (!content.trim()) {
            document.getElementById('preview-section').style.display = 'none';
            return;
        }

        let cardSep = document.getElementById('card_separator').value;
        let fieldSep = document.getElementById('field_separator').value;

        if (cardSep === 'custom') {
            cardSep = document.getElementById('custom_card_separator').value || '\n';
        }
        if (fieldSep === 'custom') {
            fieldSep = document.getElementById('custom_field_separator').value || '\t';
        }

        cardSep = cardSep.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\r/g, '\r');
        fieldSep = fieldSep.replace(/\\n/g, '\n').replace(/\\t/g, '\t').replace(/\\r/g, '\r');

        let cards;
        if (cardSep === '\n') {
            cards = content.split(/\r?\n/);
        } else {
            cards = content.split(cardSep);
        }

        let firstCard = null;
        for (let card of cards) {
            card = card.trim();
            if (card) {
                firstCard = card;
                break;
            }
        }

        if (!firstCard) {
            document.getElementById('preview-section').style.display = 'none';
            return;
        }

        const parts = firstCard.split(fieldSep);
        const front = parts[0] ? parts[0].trim() : '';
        const back = parts[1] ? parts[1].trim() : '';

        document.getElementById('preview-front').textContent = front || '(empty)';
        document.getElementById('preview-back').textContent = back || '(empty)';

        const totalCards = cards.filter(c => c.trim()).length;
        document.getElementById('preview-note').textContent = `Total ${totalCards} card(s) recognized`;

        document.getElementById('preview-section').style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function () {
        const textArea = document.getElementById('text_content');
        if (textArea) {
            textArea.addEventListener('input', updatePreview);
        }
    });
</script>
{% endblock %}