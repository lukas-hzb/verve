{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="learn-header">
        <h1>{{ set_name.replace('_', ' ') | title }}</h1>
        <div class="learn-controls">
            <div class="practice-mode-toggle">
                <label class="switch">
                    <input type="checkbox" id="practice-mode-checkbox">
                    <span class="slider round"></span>
                </label>
                <span>Practice Mode</span>
            </div>
            <button class="btn btn-secondary control-btn" id="shuffle-btn"><i data-feather="shuffle"></i>
                Shuffle</button>
            <button class="btn btn-secondary control-btn" id="back-btn" disabled><i data-feather="rotate-ccw"></i>
                Back</button>
        </div>
    </div>

    <div class="card-container">
        <div class="flashcard" id="flashcard">
            <div class="flashcard-inner">
                <div class="flashcard-front">
                    <p id="card-front">Loading...</p>
                </div>
                <div class="flashcard-back">
                    <p id="card-back"></p>
                </div>
            </div>
        </div>
        <div class="card-level" id="card-level"></div>
    </div>

    <div class="card-actions">
        <button class="btn btn-primary" id="flip-btn">Flip Card (Space)</button>
        <div id="feedback-btns" style="display: none;">
            <button class="btn btn-danger" id="not-known-btn">Didn't know (A)</button>
            <button class="btn btn-success" id="known-btn">Knew it (D)</button>
        </div>
    </div>
</div>

<!-- Add Card Modal -->
<div id="add-card-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Add New Card</h2>
            <button class="close" aria-label="Close">
                <i data-feather="x"></i>
            </button>
        </div>
        <form id="add-card-form">
            <div class="form-group">
                <label for="new-card-front">Front</label>
                <textarea id="new-card-front" name="front" class="form-control" required rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="new-card-back">Back</label>
                <textarea id="new-card-back" name="back" class="form-control" required rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Add Card</button>
            </div>
        </form>
    </div>
</div>

<script>
    const setId = {{ set_id }};

    // Modal Logic
    const modal = document.getElementById("add-card-modal");
    const btn = document.getElementById("add-card-btn");
    const span = document.getElementsByClassName("close")[0];
    const addCardForm = document.getElementById("add-card-form");

    // We need to handle the button click if it exists (it might be in a different part of the UI)
    // But wait, where is add-card-btn? It's not in the viewed file content!
    // It might be in layout.html or dynamically added?
    // Actually, looking at the file content again, I don't see add-card-btn in the HTML structure I viewed.
    // But the script references it. 
    // I will keep the modal logic as is, assuming the button exists somewhere.

    if (btn) {
        btn.onclick = function () {
            modal.style.display = "block";
            document.getElementById("new-card-front").focus();
        }
    }

    if (span) {
        span.onclick = function () {
            modal.style.display = "none";
        }
    }

    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    if (addCardForm) {
        addCardForm.onsubmit = async function (e) {
            e.preventDefault();
            const front = document.getElementById("new-card-front").value;
            const back = document.getElementById("new-card-back").value;

            try {
                const response = await fetch(`/set/${setId}/add_card`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ front, back }),
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById("new-card-front").value = "";
                    document.getElementById("new-card-back").value = "";
                    document.getElementById("new-card-front").focus();

                    // Reload the page to show the new card if it's the only one, 
                    // or let FlashcardManager handle it (it might need a reload or re-fetch)
                    // For now, simple reload is safest to ensure FlashcardManager sees the new card
                    window.location.reload();
                } else {
                    alert("Error: " + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert("An error occurred while adding the card.");
            }
        }
    }
</script>
{% endblock %}