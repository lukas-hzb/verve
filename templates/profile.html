{% extends "base.html" %}

{% block content %}
<div
    style="padding: 15px var(--space-6) var(--space-6) var(--space-6); max-width: 1400px; width: 100%; margin: 0 auto;">

    <style>
        /* Restored Original Profile Styles */
        .profile-card {
            text-align: center;
            padding: var(--space-8);
            margin-bottom: var(--space-6);
        }

        .profile-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--color-primary), #a19dff);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: 700;
            margin: 0 auto var(--space-6);
            box-shadow: var(--shadow-md);
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            color: white;
            border-radius: 50%;
        }

        .profile-avatar-large:hover .avatar-overlay {
            opacity: 1;
        }

        .profile-info h1 {
            margin: 0 0 var(--space-2);
            font-size: 28px;
        }

        .profile-info p {
            margin: var(--space-1) 0;
            color: var(--color-text-muted);
        }
    </style>

    <!-- Profile Header (Restored Original) -->
    <div class="card-normal profile-card">
        <div class="profile-avatar-large" onclick="document.getElementById('avatar').click()">
            {% if current_user.avatar_file %}
            <img id="avatar-preview-img" src="{{ current_user.avatar_file }}" alt="Avatar"
                style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
            {% else %}
            <div id="avatar-initials"
                style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
                {{ current_user.username[0].upper() }}
            </div>
            <img id="avatar-preview-img" src="" alt="Avatar"
                style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
            {% endif %}

            <div class="avatar-overlay">
                <span class="material-symbols-outlined" style="color: white; font-size: 24px;">photo_camera</span>
                {% if current_user.avatar_file %}
                <span class="material-symbols-outlined" onclick="event.stopPropagation(); resetAvatar();"
                    style="color: white; margin-left: 10px; cursor: pointer;" title="Remove">close</span>
                {% endif %}
            </div>
        </div>

        <div class="profile-info">
            <h1>{{ current_user.username }}</h1>
            <p>{{ current_user.email }}</p>
            <p style="font-size: var(--font-size-sm);">Member since {{ current_user.created_at.strftime('%d.%m.%Y') }}
            </p>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="card-grid-3" style="margin-bottom: var(--space-8);">
        <div class="card-stat" style="--icon-color: var(--color-primary-muted);">
            <div class="card-icon-wrapper" style="--icon-color: var(--color-primary-muted);">
                <span class="material-symbols-outlined" style="color: white; font-size: 28px;">folder</span>
            </div>
            <div class="card-stat-content">
                <p class="card-stat-value">{{ sets|length }}</p>
                <p class="card-stat-label">Sets</p>
            </div>
        </div>

        <div class="card-stat" style="--icon-color: var(--color-accent-4);">
            <div class="card-icon-wrapper" style="--icon-color: var(--color-accent-4);">
                <span class="material-symbols-outlined" style="color: white; font-size: 28px;">check_circle</span>
            </div>
            <div class="card-stat-content">
                <p class="card-stat-value">{{ total_cards }}</p>
                <p class="card-stat-label">Total Cards</p>
            </div>
        </div>

        <div class="card-stat" style="--icon-color: var(--color-accent-2);">
            <div class="card-icon-wrapper" style="--icon-color: var(--color-accent-2);">
                <span class="material-symbols-outlined" style="color: white; font-size: 28px;">schedule</span>
            </div>
            <div class="card-stat-content">
                <p class="card-stat-value">{{ due_cards }}</p>
                <p class="card-stat-label">Due Cards</p>
            </div>
        </div>
    </div>

    <!-- Account Settings -->
    <div style="margin-bottom: var(--space-8);">
        <!-- No header here as per strict template adherence, or keep section header? 
             debug.html shows Input Cards section with a wrapper H2. 
             If we strictly follow "Input Cards", it's a card-normal with titles and inputs. 
             We can keep the outer section header "Account Settings" or remove it if user wants STRICT adherence.
             But a page usually needs section headers. "Account Settings" h2 seems consistent with "Stats Cards" h2 in debug.
        -->
        <h2 style="margin-bottom: var(--space-4);">Account Settings</h2>

        <div class="card-normal">
            <form id="profile-form" onsubmit="handleProfileUpdate(event)">

                <h3 class="card-normal-title">Username</h3>
                <div class="card-input-group" style="margin-bottom: var(--space-6);">
                    <input type="text" id="username" name="username" value="{{ current_user.username }}" required
                        class="card-input" placeholder="The username used to login...">
                </div>

                <h3 class="card-normal-title">Email</h3>
                <div class="card-input-group">
                    <input type="email" id="email" name="email" value="{{ current_user.email }}" required
                        class="card-input" placeholder="Your email address...">
                </div>

                <div style="display: none;">
                    <input type="file" id="avatar" name="avatar" accept=".jpg,.jpeg,.png,.gif"
                        onchange="previewAvatar(this)">
                    <input type="hidden" id="remove-avatar" name="remove_avatar" value="false">
                </div>

                <div class="button-group" style="margin-top: var(--space-6);">
                    <button type="submit" id="save-profile-btn" class="btn-primary" disabled>
                        <span class="material-symbols-outlined">save</span>
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Danger Zone -->
    <div class="card-attention">
        <div class="card-attention-header">
            <span class="material-symbols-outlined card-attention-icon">warning</span>
            <h3 class="card-attention-title">Danger Zone</h3>
        </div>
        <p class="card-attention-text" style="color: var(--color-text-muted); margin-bottom: var(--space-4);">Actions in
            this section can affect your account security.</p>
        <div class="button-group">
            <a href="{{ url_for('auth.change_password') }}" class="btn-danger-secondary"
                style="justify-content: center; text-decoration: none;">Change Password</a>
            <a href="{{ url_for('auth.logout') }}" class="btn-danger-secondary"
                style="justify-content: center; text-decoration: none;">Logout</a>
            <button type="button" class="btn-danger" onclick="openDeleteModal()">Delete Account</button>
        </div>
    </div>
</div>

<!-- Delete Account Confirmation Modal -->
<div id="delete-account-modal" class="popup-overlay">
    <div class="popup-content popup-attention" style="max-width: 400px;">
        <div class="popup-header">
            <h3 class="popup-title">Delete Account</h3>
        </div>
        <div class="popup-body">
            <p>Are you sure you want to delete your account? This action cannot be undone. All your sets and progress
                will be permanently deleted.</p>
        </div>
        <div class="popup-footer">
            <button type="button" class="btn-danger-secondary" onclick="closeDeleteModal()">Cancel</button>
            <form action="{{ url_for('auth.delete_account') }}" method="POST" style="display: contents;">
                <button type="submit" class="btn-danger">Delete Account</button>
            </form>
        </div>
    </div>
</div>

<script>
    // Store original values to track changes
    window.originalValues = {
        username: '',
        email: ''
    };

    document.addEventListener('DOMContentLoaded', function () {
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');

        if (usernameInput) {
            window.originalValues.username = usernameInput.value;
            usernameInput.addEventListener('input', window.checkFormChanges);
        }
        if (emailInput) {
            window.originalValues.email = emailInput.value;
            emailInput.addEventListener('input', window.checkFormChanges);
        }

        window.checkFormChanges();
    });

    window.checkFormChanges = function () {
        const username = document.getElementById('username').value;
        const email = document.getElementById('email').value;
        const saveBtn = document.getElementById('save-profile-btn');

        const hasChanges =
            username !== window.originalValues.username ||
            email !== window.originalValues.email;

        if (saveBtn) {
            saveBtn.disabled = !hasChanges;
        }
    };

    // Auto-save Avatar on Selection
    window.previewAvatar = function (input) {
        if (input.files && input.files[0]) {
            handleAvatarUpdate(input.files[0], false);
        }
    };

    // Auto-save Avatar on Removal
    window.resetAvatar = function () {
        handleAvatarUpdate(null, true);
    };

    window.handleAvatarUpdate = async function (file, remove) {
        const overlay = document.querySelector('.avatar-overlay');
        const originalOverlayContent = overlay.innerHTML;

        // Show loading state in overlay
        overlay.innerHTML = '<span class="material-symbols-outlined" style="color: white; animation: spin 1s linear infinite;">sync</span>';
        overlay.style.opacity = '1'; // Force show overlay

        const formData = new FormData();
        // Append current text values (required by backend to not clear them)
        formData.append('username', document.getElementById('username').value);
        formData.append('email', document.getElementById('email').value);

        if (remove) {
            formData.append('remove_avatar', 'true');
        } else if (file) {
            formData.append('avatar', file);
            formData.append('remove_avatar', 'false');
        }

        try {
            const response = await fetch("{{ url_for('auth.update_profile') }}", {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                // Reload the page to ensure stability and show the flash message
                window.location.reload();
            } else {
                alert('Error: ' + data.message);
                overlay.innerHTML = originalOverlayContent; // Revert on error
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
            overlay.innerHTML = originalOverlayContent; // Revert on error
        } finally {
            overlay.style.opacity = ''; // Remove forced opacity
        }
    };

    function updateSidebar(data) {
        const sidebarPlaceholder = document.querySelector('.sidebar-icon-placeholder');
        if (!sidebarPlaceholder) return;

        if (data.avatar_url) {
            sidebarPlaceholder.innerHTML = `<img src="${data.avatar_url}" alt="Avatar" class="sidebar-avatar">`;
        } else {
            sidebarPlaceholder.innerHTML = `<div class="sidebar-avatar-text">${data.initials}</div>`;
        }
    }

    function showSuccessMessage(msg) {
        const container = document.querySelector('.profile-card').parentNode;
        const existingAlert = container.querySelector('.alert-success');
        if (existingAlert) existingAlert.remove();

        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success';
        alertDiv.innerHTML = `
            <span class="material-symbols-outlined alert-icon">check_circle</span>
            <span class="alert-message">${msg}</span>
            <span class="material-symbols-outlined alert-close" onclick="this.parentElement.remove()">close</span>
        `;
        container.insertBefore(alertDiv, document.querySelector('.profile-card'));
        setTimeout(() => {
            alertDiv.style.opacity = '0';
            setTimeout(() => alertDiv.remove(), 300);
        }, 3000);
    }

    // Handle updates for Text Fields (Button Press)
    window.handleProfileUpdate = async function (event) {
        event.preventDefault();

        const form = event.target;
        const formData = new FormData(form);
        const saveBtn = document.getElementById('save-profile-btn');
        const originalText = saveBtn.innerHTML;

        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="material-symbols-outlined" style="animation: spin 1s linear infinite;">sync</span> Saving...';

        try {
            const response = await fetch("{{ url_for('auth.update_profile') }}", {
                method: 'POST',
                body: formData,
                headers: { 'Accept': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                window.originalValues.username = document.getElementById('username').value;
                window.originalValues.email = document.getElementById('email').value;
                showSuccessMessage(data.message);
                updateSidebar(data); // Sync sidebar in case initials changed due to username change
                window.checkFormChanges();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
        } finally {
            saveBtn.innerHTML = originalText;
            window.checkFormChanges();
        }
    };
</script>
{% endblock %}
```